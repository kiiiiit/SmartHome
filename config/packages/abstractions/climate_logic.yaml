# Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ ÐºÐ»Ð¸Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð»Ð¾Ð³Ð¸ÐºÐ¸ (Single Responsibility)
automation:
  # Ð•Ð´Ð¸Ð½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð»ÐµÑ€ Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñ‹ (Ð²Ð¼ÐµÑÑ‚Ð¾ Ð´ÑƒÐ±Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ)
  - alias: "Climate - Universal Temperature Controller"
    description: "Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð»ÐµÑ€ ÐºÐ»Ð¸Ð¼Ð°Ñ‚Ð°"
    trigger:
      - platform: state
        entity_id: 
          - sensor.pok005_temperature
          - sensor.home_average_temperature
          - binary_sensor.anyone_home
          - input_boolean.homekit_home_mode
          - input_boolean.homekit_away_mode
          - input_boolean.homekit_sleep_mode
      - platform: time_pattern
        minutes: "/30"
    variables:
      outdoor_temp: "{{ states('sensor.pok005_temperature') | float(-999) }}"
      indoor_temp: "{{ states('sensor.home_average_temperature') | float(20) }}"
      is_home: "{{ is_state('binary_sensor.anyone_home', 'on') }}"
      current_hour: "{{ now().hour }}"
      is_night: "{{ current_hour >= 23 or current_hour < 6 }}"
      # Ð˜Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¶Ð¸Ð¼Ð°
      target_mode: >
        {% if is_state('input_boolean.homekit_away_mode', 'on') %}
          away
        {% elif is_state('input_boolean.homekit_sleep_mode', 'on') or is_night %}
          night
        {% elif outdoor_temp < -15 %}
          freeze_protection
        {% elif not is_home %}
          away
        {% else %}
          comfort
        {% endif %}
    condition:
      - condition: template
        value_template: "{{ outdoor_temp != -999 }}"  # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…
    action:
      - service: script.smart_set_temperature
        data:
          mode: "{{ target_mode }}"

# Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð»ÐµÑ€Ñ‹ (Single Responsibility)
automation:
  # Ð­Ð½ÐµÑ€Ð³Ð¾Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ (Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð°Ñ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ)
  - alias: "Climate - Energy Optimization"
    description: "ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÐ½ÐµÑ€Ð³Ð¾Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÐµÐ½Ð¸Ñ"
    trigger:
      - platform: state
        entity_id: sensor.boiler_modulation
      - platform: numeric_state
        entity_id: sensor.boiler_modulation
        above: "{{ states('homeassistant.customize_glob.*threshold_constants*.high_modulation') | int }}"
        for: "00:10:00"
    action:
      - service: script.send_climate_notification
        data:
          title: "âš¡ Ð­Ð½ÐµÑ€Ð³Ð¾Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ"
          message: "Ð’Ñ‹ÑÐ¾ÐºÐ°Ñ Ð¼Ð¾Ð´ÑƒÐ»ÑÑ†Ð¸Ñ {{ states('sensor.boiler_modulation') }}%. Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ ÑÐ½Ð¸Ð¶ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñ‹."
      - service: script.smart_set_temperature
        data:
          mode: economy

  # Ð—Ð°Ñ‰Ð¸Ñ‚Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ (Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð°Ñ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ)  
  - alias: "Climate - System Protection"
    description: "Ð—Ð°Ñ‰Ð¸Ñ‚Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð¾Ñ‚Ð¾Ð¿Ð»ÐµÐ½Ð¸Ñ"
    trigger:
      - platform: numeric_state
        entity_id: sensor.pok005_temperature
        below: "{{ states('homeassistant.customize_glob.*threshold_constants*.extreme_cold') | int }}"
      - platform: state
        entity_id: binary_sensor.boiler_fault
        to: 'on'
      - platform: numeric_state
        entity_id: sensor.home_average_humidity
        above: "{{ states('homeassistant.customize_glob.*threshold_constants*.high_humidity') | int }}"
        for: "01:00:00"
    action:
      - choose:
          - conditions:
              - condition: numeric_state
                entity_id: sensor.pok005_temperature  
                below: "{{ states('homeassistant.customize_glob.*threshold_constants*.extreme_cold') | int }}"
            sequence:
              - service: script.smart_set_temperature
                data:
                  mode: freeze_protection
              - service: script.send_climate_notification
                data:
                  title: "ðŸ¥¶ Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Ð·Ð°Ð¼ÐµÑ€Ð·Ð°Ð½Ð¸Ñ"
                  message: "ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ñ€ÐµÐ¶Ð¸Ð¼ Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹ Ð¾Ñ‚ Ð·Ð°Ð¼ÐµÑ€Ð·Ð°Ð½Ð¸Ñ"
                  priority: high
          - conditions:
              - condition: state
                entity_id: binary_sensor.boiler_fault
                state: 'on'
            sequence:
              - service: script.send_climate_notification
                data:
                  title: "âš ï¸ ÐÐµÐ¸ÑÐ¿Ñ€Ð°Ð²Ð½Ð¾ÑÑ‚ÑŒ ÐºÐ¾Ñ‚Ð»Ð°"
                  message: "ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð° Ð½ÐµÐ¸ÑÐ¿Ñ€Ð°Ð²Ð½Ð¾ÑÑ‚ÑŒ ÐºÐ¾Ñ‚Ð»Ð° BAXI"
                  priority: high
